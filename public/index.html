<html>
    <head>
        <title>Iconosur Node Server</title>
    </head>
    <body>
        <form ref='uploadForm' 
            id='uploadForm' 
            action='/upload' 
            method='post' 
            encType="multipart/form-data">
          <input type="file" name="image" />
          <input type='submit' value='Upload!' class="upload" disabled/>
      </form>
      <select>
      </select>
      <div class="new--category">
        <input type="text" placeholder="Categoría">
        <button>Crear Categoría</button>
      </div>
    </body>
    <script>
        (function(window){
            const select = document.querySelector('select')
            const upload = document.querySelector('.upload')
            const form = document.querySelector('form')
            const categoryContainer = document.querySelector('.new--category')
            const categoryInput = categoryContainer.querySelector('input')
            const categoryButton = categoryContainer.querySelector('button')
            
            get('/categories').then(e => {
                addOption(select, 'ninguna')
                JSON.parse(e.response).forEach(opt => addOption(select, opt))
            }).catch(console.error)

            select.addEventListener('change', (event) => {
                upload.disabled = select.value === 'ninguna'
                form.action = `/upload?category=${select.value}`
            })

            categoryButton.addEventListener('click', () => {
                const category = categoryInput.value
                if(category.trim() !== '') post(`/categories?category=${category}`)
                    .then(() => {
                        categoryInput.value = ''
                        console.log(`Categoría: ${category} creada`)
                    }).catch(console.error)
            })

            function get(path) {
                return new Promise((resolve, reject) => {
                    const xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if(this.readyState == 4){
                            if (this.status == 200) resolve(this)
                            else if(this.status > 400) reject(this)
                        }
                    };
                    xhttp.open("GET", path, true);
                    xhttp.send();
                })
            }

            function post(path) {
                return new Promise((resolve, reject) => {
                    const xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if(this.readyState == 4){
                            if (this.status == 200) resolve(this)
                            else if(this.status > 400) reject(this)
                        }
                    };
                    xhttp.open("POST", path, true);
                    xhttp.send();
                })
            }

            function addOption(select, option) {
                const opt = document.createElement('OPTION')
                opt.value = option
                opt.textContent = option.split(' ').map(e => e.substring(0, 1).toUpperCase() + e.substring(1)).join('')
                select.appendChild(opt)
            }
        })(window);
    </script>
</html>